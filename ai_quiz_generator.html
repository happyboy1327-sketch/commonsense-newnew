<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ìƒì‹ í€´ì¦ˆ</title>
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body { 
    font-family: 'Noto Sans KR', sans-serif; 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height:100vh; 
    padding:20px;
    display:flex;
    flex-direction:column;
    align-items:center;
  }
  h1 { 
    color:#fff; 
    text-align:center; 
    margin-bottom:20px; 
    font-size:2em;
    text-shadow:2px 2px 4px rgba(0,0,0,0.3);
  }
  #wrongCount {
    position:fixed;
    top:10px;
    right:10px;
    background:#fff;
    padding:10px 15px;
    border-radius:20px;
    font-weight:bold;
    color:#764ba2;
    box-shadow:0 4px 6px rgba(0,0,0,0.1);
  }
  .timer {
    font-size:2em;
    font-weight:bold;
    color:#fff;
    text-align:center;
    margin-bottom:20px;
    text-shadow:2px 2px 4px rgba(0,0,0,0.3);
  }
  .quiz-container {
    background:#fff;
    padding:30px;
    border-radius:20px;
    box-shadow:0 10px 30px rgba(0,0,0,0.2);
    max-width:700px;
    width:100%;
  }
  .quiz-box {
    font-size:1.3em;
    font-weight:500;
    margin-bottom:30px;
    line-height:1.6;
    color:#333;
  }
  .options {
    display:flex;
    flex-direction:column;
    gap:15px;
    margin-bottom:20px;
  }
  .options button {
    padding:15px;
    border:2px solid #667eea;
    background:#fff;
    border-radius:12px;
    font-size:1.1em;
    cursor:pointer;
    transition:all 0.3s;
    text-align:left;
  }
  .options button:hover:not(:disabled) {
    background:#667eea;
    color:#fff;
    transform:translateY(-2px);
    box-shadow:0 4px 8px rgba(102,126,234,0.3);
  }
  .options button.correct {
    background:#10b981;
    color:#fff;
    border-color:#10b981;
  }
  .options button.wrong {
    background:#ef4444;
    color:#fff;
    border-color:#ef4444;
  }
  .explanation {
    background:#f3f4f6;
    padding:20px;
    border-radius:12px;
    margin-top:20px;
    line-height:1.6;
    color:#374151;
    white-space:pre-line;
  }
  .controls {
    display:flex;
    gap:10px;
    margin-top:20px;
    flex-wrap:wrap;
  }
  .controls button, #nextBtn {
    padding:12px 24px;
    border:none;
    background:#667eea;
    color:#fff;
    border-radius:8px;
    font-size:1em;
    cursor:pointer;
    transition:all 0.3s;
    font-weight:600;
  }
  .controls button:hover, #nextBtn:hover {
    background:#764ba2;
    transform:translateY(-2px);
    box-shadow:0 4px 8px rgba(118,75,162,0.3);
  }
  .hidden { display:none; }
  hr {
    margin:20px 0;
    border:none;
    border-top:2px solid #e5e7eb;
  }

  @media(max-width: 480px) {
    body { padding: 5px; }
    .quiz-container { padding: 15px; }
    .quiz-box { font-size: 1em; }
    .options button { padding: 10px; font-size: 0.95em; }
    .timer { font-size: 1.5em; }
    .controls button { padding: 8px 12px; font-size: 0.95em; }
  }
</style>
</head>
<body>
<h1>ìƒì‹ í€´ì¦ˆ</h1>
<div id="wrongCount">ì˜¤ë‹µ: 0</div>
<div class="timer" id="timer">12</div>
<div class="quiz-container">
  <div class="quiz-box" id="quizBox"></div>
  <div class="options" id="options"></div>
  <div class="explanation" id="explanation"></div>
  <button id="nextBtn" class="hidden">ë‹¤ìŒ ë¬¸ì œ</button>
  <hr>
  <div class="controls">
    <button id="reviewBtn">ì˜¤ë‹µ ë³µìŠµ</button>
    <button id="testBtn" style="background:#f59e0b;">ğŸ§ª í…ŒìŠ¤íŠ¸: ë‚´ì¼ë¡œ ë³€ê²½</button>
    <button id="forceGenBtn" style="background:#10b981;">ğŸ¤– ê°•ì œ ë¬¸ì œ ìƒì„±</button>
  </div>
</div>

<script>
// ì´ˆê¸° ë¬¸ì œ ë°°ì—´
let quizzes = [
  { question: 'ì‚¬ê³„ì ˆ ì¤‘ ê°€ì¥ ì¶”ìš´ ê³„ì ˆì€ ë¬´ì—‡ì¼ê¹Œìš”?', options: ['ë´„','ì—¬ë¦„','ê°€ì„','ê²¨ìš¸'], answer: 3, explanation: 'ê²¨ìš¸ì€ íƒœì–‘ê³¼ì˜ ê±°ë¦¬ê°€ ìƒëŒ€ì ìœ¼ë¡œ ë©€ê³ , ì§€êµ¬ì˜ ê¸°ìš¸ê¸°ë¡œ ì¸í•´ íƒœì–‘ê´‘ì´ ì ê²Œ ë„ë‹¬í•˜ë¯€ë¡œ ê°€ì¥ ì¶”ìš´ ê³„ì ˆì…ë‹ˆë‹¤.' },
  { question: 'íƒœì–‘ê³„ì˜ ì¤‘ì‹¬ì— ìˆëŠ” í•­ì„±ì€ ë¬´ì—‡ì¼ê¹Œìš”?', options: ['ì§€êµ¬','ë‹¬','í™”ì„±','íƒœì–‘'], answer: 3, explanation: 'íƒœì–‘ê³„ì˜ ì¤‘ì‹¬ì—ëŠ” íƒœì–‘ì´ ìˆìœ¼ë©°, ì¤‘ë ¥ìœ¼ë¡œ í–‰ì„±ë“¤ì´ ê³µì „í•˜ê³  ìˆìŠµë‹ˆë‹¤.' },
  { question: 'ë¥´ë„¤ìƒìŠ¤ ì‹œëŒ€ì˜ ëŒ€í‘œì ì¸ í™”ê°€ë¡œ "ëª¨ë‚˜ë¦¬ì"ë¥¼ ê·¸ë¦° ì‚¬ëŒì€ ëˆ„êµ¬ì¼ê¹Œìš”?', options: ['ë¹ˆì„¼íŠ¸ ë°˜ ê³ í','ë ˆì˜¤ë‚˜ë¥´ë„ ë‹¤ë¹ˆì¹˜','íŒŒë¸”ë¡œ í”¼ì¹´ì†Œ','í´ë¡œë“œ ëª¨ë„¤'], answer: 1, explanation: 'ë ˆì˜¤ë‚˜ë¥´ë„ ë‹¤ë¹ˆì¹˜(1452~1519)ëŠ” ë¥´ë„¤ìƒìŠ¤ ì‹œëŒ€ì˜ ëŒ€í‘œì  í™”ê°€ì´ì ë°œëª…ê°€ë¡œ, ê·¸ì˜ ëŒ€í‘œì‘ "ëª¨ë‚˜ë¦¬ì"ëŠ” ì„¸ê³„ì ìœ¼ë¡œ ìœ ëª…í•˜ë©° í”„ë‘ìŠ¤ ë£¨ë¸Œë¥´ ë°•ë¬¼ê´€ì— ì „ì‹œë˜ì–´ ìˆìŠµë‹ˆë‹¤.' },
  { question: 'ì¤‘êµ­ì˜ ë§Œë¦¬ì¥ì„±ì€ ë¬´ì—‡ì„ ë§‰ê¸° ìœ„í•´ ê±´ì„¤ë˜ì—ˆì„ê¹Œìš”?', options: ['ìì—°ì¬í•´', 'ì´ë¯¼ì ìœ ì…', 'ë¶ë°© ë¯¼ì¡±ì˜ ì¹¨ì…', 'ë¬´ì—­ì„  ì¶œì…'], answer: 2, explanation: 'ë§Œë¦¬ì¥ì„±ì€ ê³ ëŒ€ ì¤‘êµ­ ì—¬ëŸ¬ ì™•ì¡°ê°€ ë¶ë°© ë¯¼ì¡±, íŠ¹íˆ í‰ë…¸ì™€ ê°™ì€ ìœ ëª©ë¯¼ì˜ ì¹¨ì…ì„ ë°©ì–´í•˜ê¸° ìœ„í•´ ê±´ì„¤í•œ ì¥ëŒ€í•œ ë°©ì–´ ì‹œì„¤ì…ë‹ˆë‹¤. ê¸¸ì´ëŠ” ì•½ 2ë§Œ kmì— ë‹¬í•©ë‹ˆë‹¤.' },
  { question: 'ë…¸ë²¨ìƒì„ ìˆ˜ì—¬í•˜ëŠ” ë‚˜ë¼ëŠ” ì–´ë””ì¼ê¹Œìš”?', options: ['ë¯¸êµ­', 'ì˜êµ­', 'ìŠ¤ì›¨ë´', 'í”„ë‘ìŠ¤'], answer: 2, explanation: 'ë…¸ë²¨ìƒì€ ìŠ¤ì›¨ë´ì˜ ê³¼í•™ì ì•Œí”„ë ˆë“œ ë…¸ë²¨ì˜ ìœ ì–¸ì— ë”°ë¼ ìŠ¤ì›¨ë´ ì™•ë¦½ ê³¼í•™ì›ê³¼ ë…¸ë¥´ì›¨ì´ ë…¸ë²¨ìœ„ì›íšŒê°€ ë¶„ì•¼ë³„ë¡œ ìˆ˜ì—¬í•˜ë©°, ë¬¼ë¦¬í•™, í™”í•™, ìƒë¦¬ì˜í•™, ë¬¸í•™, í‰í™”, ê²½ì œí•™ ë¶„ì•¼ê°€ ìˆìŠµë‹ˆë‹¤.' }
];

// localStorage ê´€ë¦¬
const STORAGE_KEY = 'quizState_v2';
let state = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
  allQuizzes: [...quizzes],
  wrongs: [],
  newQuizDate: null
};

// ìš”ì†Œ
const quizBox = document.getElementById('quizBox');
const optionsDiv = document.getElementById('options');
const explanationDiv = document.getElementById('explanation');
const nextBtn = document.getElementById('nextBtn');
const timerDiv = document.getElementById('timer');
const reviewBtn = document.getElementById('reviewBtn');
const wrongCountDiv = document.getElementById('wrongCount');

let currentQuiz, timer, timeLeft;
let quizOrder = [], quizIndex = 0;
let reviewMode = false;
let reviewOrder = [], reviewIndex = 0;

// AIë¡œ í•˜ë£¨ ì‹ ê·œë¬¸ì œ ìë™ ìƒì„±
async function addDailyNewQuizzes() {
  const now = new Date();
  const kstOffset = 9 * 60;
  const kstTime = new Date(now.getTime() + (kstOffset + now.getTimezoneOffset()) * 60000);
  const today = kstTime.toISOString().slice(0, 10);
  
  console.log('ì €ì¥ëœ ë‚ ì§œ:', state.newQuizDate);
  console.log('ì˜¤ëŠ˜ ë‚ ì§œ(KST):', today);
  
  if(state.newQuizDate === today) {
    console.log('ì˜¤ëŠ˜ ì´ë¯¸ ë¬¸ì œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
    return;
  }
  
  console.log('AIê°€ ìƒˆë¡œìš´ ë¬¸ì œë¥¼ ìƒì„± ì¤‘...');
  
  try {
    // Gemini API ì‚¬ìš©
    const response = await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=AIzaSyDmw9LZ5Gl02akGh1UcW_B5tgr_1acZiO4", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        contents: [{
          parts: [{
            text: `ë‹¤ì–‘í•œ ì£¼ì œ(ì—­ì‚¬, ê³¼í•™, ë¬¸í•™, ì˜ˆìˆ , ê²½ì œ, ì² í•™ ë“±)ì˜ ìƒì‹ í€´ì¦ˆ 5ê°œë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”. 
ê° ë¬¸ì œëŠ” 4ì§€ì„ ë‹¤í˜•ì´ë©°, ë‚œì´ë„ëŠ” ì¤‘ìƒ ìˆ˜ì¤€ì…ë‹ˆë‹¤.

ë°˜ë“œì‹œ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•´ì£¼ì„¸ìš” (ë‹¤ë¥¸ ì„¤ëª…ì´ë‚˜ ë§ˆí¬ë‹¤ìš´ ì½”ë“œë¸”ë¡ ì—†ì´):
[
  {
    "question": "ë¬¸ì œ ë‚´ìš©",
    "options": ["ë³´ê¸°1", "ë³´ê¸°2", "ë³´ê¸°3", "ë³´ê¸°4"],
    "answer": 0,
    "explanation": "ìƒì„¸í•œ í•´ì„¤"
  }
]`
          }]
        }]
      })
    });
    
    const data = await response.json();
    console.log('API ì‘ë‹µ:', data);
    
    if (!data.candidates || !data.candidates[0]) {
      throw new Error('API ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜');
    }
    
    const content = data.candidates[0].content.parts[0].text;
    console.log('ì›ë³¸ í…ìŠ¤íŠ¸:', content);
    
    const cleanContent = content.replace(/```json|```/g, '').trim();
    const newQuizzes = JSON.parse(cleanContent);
    
    newQuizzes.forEach(quiz => {
      state.allQuizzes.push(quiz);
    });
    
    state.newQuizDate = today;
    saveState();
    
    console.log('ìƒˆ ë¬¸ì œ 5ê°œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
    console.log('ì´ ë¬¸ì œ ìˆ˜:', state.allQuizzes.length);
    
  } catch (error) {
    console.error('ë¬¸ì œ ìƒì„± ì‹¤íŒ¨:', error);
    alert('ë¬¸ì œ ìƒì„± ì‹¤íŒ¨: ' + error.message + '\nê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
  }
}

function saveState() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  wrongCountDiv.textContent = `ì˜¤ë‹µ: ${state.wrongs.length}`;
}

function shuffleQuizzes(pool) {
  let arr = [...pool];
  for(let i=arr.length-1;i>0;i--){
    let j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
  return arr;
}

function showQuiz(quiz) {
  currentQuiz = quiz;
  quizBox.textContent = quiz.question;
  optionsDiv.innerHTML = '';
  explanationDiv.textContent = '';
  nextBtn.classList.add('hidden');

  quiz.options.forEach((opt,i)=>{
    const btn = document.createElement('button');
    btn.textContent = opt;
    btn.onclick = ()=>checkAnswer(i,btn);
    optionsDiv.appendChild(btn);
  });

  timeLeft = 12;
  timerDiv.textContent = timeLeft;
  clearInterval(timer);
  timer = setInterval(()=>{
    timeLeft--;
    timerDiv.textContent = timeLeft;
    if(timeLeft <=0){
      clearInterval(timer);
      checkAnswer(-1,null);
    }
  },1000);
}

function checkAnswer(selected, btn) {
  clearInterval(timer);
  optionsDiv.querySelectorAll('button').forEach((b,i)=>{
    b.disabled = true;
    if(i===currentQuiz.answer) b.classList.add('correct');
    else if(i===selected && selected!==currentQuiz.answer) b.classList.add('wrong');
  });

  const correct = selected === currentQuiz.answer;
  if(!correct){
    if(!state.wrongs.find(q=>q.question===currentQuiz.question)){
      state.wrongs.push(currentQuiz);
    }
  }

  explanationDiv.textContent = `ì •ë‹µ: ${currentQuiz.options[currentQuiz.answer]}\n${currentQuiz.explanation}`;
  saveState();
  nextBtn.classList.remove('hidden');
}

nextBtn.onclick = ()=>{
  if(reviewMode){
    reviewIndex++;
    if(reviewIndex >= reviewOrder.length){
      alert('ì˜¤ë‹µ ë³µìŠµì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!');
      reviewMode = false;
      quizIndex = 0;
      quizOrder = shuffleQuizzes(state.allQuizzes);
      showQuiz(quizOrder[quizIndex]);
    } else {
      showQuiz(reviewOrder[reviewIndex]);
    }
  } else {
    quizIndex++;
    if(quizIndex >= quizOrder.length){
      alert('ëª¨ë“  ë¬¸ì œë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!');
      quizIndex = 0;
      quizOrder = shuffleQuizzes(state.allQuizzes);
      showQuiz(quizOrder[quizIndex]);
    } else {
      showQuiz(quizOrder[quizIndex]);
    }
  }
};

reviewBtn.onclick = ()=>{
  if(state.wrongs.length===0){
    alert('ì˜¤ë‹µì´ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  reviewMode = true;
  reviewOrder = shuffleQuizzes(state.wrongs);
  reviewIndex = 0;
  showQuiz(reviewOrder[reviewIndex]);
};

// í…ŒìŠ¤íŠ¸: ë‚ ì§œë¥¼ ì–´ì œë¡œ ë³€ê²½
document.getElementById('testBtn').onclick = ()=>{
  const now = new Date();
  const kstOffset = 9 * 60;
  const kstTime = new Date(now.getTime() + (kstOffset + now.getTimezoneOffset()) * 60000);
  const yesterday = new Date(kstTime);
  yesterday.setDate(yesterday.getDate() - 1);
  const yesterdayStr = yesterday.toISOString().slice(0, 10);
  
  state.newQuizDate = yesterdayStr;
  saveState();
  
  alert(`ë‚ ì§œë¥¼ ì–´ì œ(${yesterdayStr})ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ë©´ AIê°€ ìƒˆ ë¬¸ì œë¥¼ ìƒì„±í•©ë‹ˆë‹¤!`);
};

// í…ŒìŠ¤íŠ¸: ê°•ì œë¡œ ë¬¸ì œ ìƒì„±
document.getElementById('forceGenBtn').onclick = async ()=>{
  const btn = document.getElementById('forceGenBtn');
  btn.disabled = true;
  btn.textContent = 'â³ ìƒì„± ì¤‘...';
  
  try {
    const oldDate = state.newQuizDate;
    state.newQuizDate = '2020-01-01';
    await addDailyNewQuizzes();
    
    quizOrder = shuffleQuizzes(state.allQuizzes);
    showQuiz(quizOrder[0]);
    
    alert(`âœ… ìƒˆ ë¬¸ì œ 5ê°œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!\nì´ ë¬¸ì œ ìˆ˜: ${state.allQuizzes.length}`);
  } catch(error) {
    alert('âŒ ë¬¸ì œ ìƒì„± ì‹¤íŒ¨: ' + error.message);
  } finally {
    btn.disabled = false;
    btn.textContent = 'ğŸ¤– ê°•ì œ ë¬¸ì œ ìƒì„±';
  }
};

// ì´ˆê¸° ì‹¤í–‰
(async function init() {
  await addDailyNewQuizzes();
  quizOrder = shuffleQuizzes(state.allQuizzes);
  showQuiz(quizOrder[quizIndex]);
  saveState();
})();
</script>
</body>
</html>